<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Drawing Widget</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>
    <script src="config.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&display=swap');
        
        :root {
            --navy: #0F2458;
            --blue-mid: #5381A1;
            --cyan: #0ABAEF;
            --light-bg: #E8EEF5;
            --pink: #E92F8B;
            --orange: #E76F41;
            --yellow: #FEE980;
            --white: #ffffff;
            --green: #10B981;
            --shadow-sm: 0 1px 3px rgba(15, 36, 88, 0.08);
            --shadow-lg: 0 20px 40px rgba(15, 36, 88, 0.25);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--light-bg);
            color: var(--navy);
            line-height: 1.5;
            overflow: hidden;
        }
        
        .widget-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            height: 100vh;
            background: var(--light-bg);
            transition: all 0.3s ease;
        }

        .site-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--navy);
            border-radius: 10px;
            color: var(--white);
            flex-shrink: 0;
        }
        
        .site-icon {
            width: 40px;
            height: 40px;
            background: var(--blue-mid);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            background: var(--white);
            border-radius: 10px;
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }
        
        .toolbar-group {
            display: flex;
            gap: 4px;
            padding-right: 12px;
            border-right: 1px solid var(--light-bg);
        }
        .toolbar-group:last-child { border-right: none; padding-right: 0; }
        
        .tool-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 500;
            color: var(--navy);
            background: var(--light-bg);
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .tool-btn:hover { background: #d9e4ef; }
        .tool-btn.active { background: var(--cyan); color: var(--white); }
        .tool-btn.danger { color: var(--orange); }
        .tool-btn.danger:hover { background: #fef3ed; }
        .tool-btn.success { color: var(--green); }
        .tool-btn.success:hover { background: #ecfdf5; }
        .tool-btn svg { width: 16px; height: 16px; }
        
        .map-wrapper {
            position: relative;
            flex: 1;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            min-height: 300px;
        }
        
        #map { width: 100%; height: 100%; background: #d9e4ef; }
        
        .map-controls {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 100;
        }
        
        .map-overlay {
            position: absolute;
            bottom: 12px;
            right: 12px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(4px);
            border-radius: 6px;
            font-size: 12px;
            color: var(--blue-mid);
            pointer-events: none;
            z-index: 100;
        }
        
        .status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--white);
            border-radius: 8px;
            font-size: 12px;
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }
        
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--blue-mid);
            margin-right: 6px;
        }
        .status-dot.ready { background: var(--cyan); }
        .status-dot.drawing { background: var(--yellow); animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .layer-selector { display: flex; gap: 4px; margin-left: auto; }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 36, 88, 0.6);
            backdrop-filter: blur(2px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        
        .modal-overlay.show { opacity: 1; visibility: visible; }
        
        .modal-box {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 340px;
            box-shadow: var(--shadow-lg);
            transform: scale(0.95);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .modal-overlay.show .modal-box { transform: scale(1); }
        .modal-title { font-size: 18px; font-weight: 600; color: var(--navy); margin-bottom: 8px; }
        .modal-message { font-size: 14px; color: var(--blue-mid); margin-bottom: 24px; line-height: 1.5; }
        .modal-buttons { display: flex; gap: 12px; justify-content: flex-end; }
        
        .modal-btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            transition: background 0.15s;
        }
        
        .modal-btn.cancel { background: var(--light-bg); color: var(--navy); }
        .modal-btn.cancel:hover { background: #d9e4ef; }
        .modal-btn.primary { background: var(--cyan); color: var(--white); }
        .modal-btn.primary:hover { filter: brightness(1.1); }
        .modal-btn.danger { background: var(--orange); color: var(--white); }
        .modal-btn.danger:hover { background: #d4623a; }

        .name-input {
            width: 100%;
            padding: 12px 14px;
            font-size: 14px;
            font-family: inherit;
            border: 2px solid var(--light-bg);
            border-radius: 8px;
            margin-bottom: 16px;
            transition: border-color 0.2s;
        }
        .name-input:focus {
            outline: none;
            border-color: var(--cyan);
        }
        .name-input::placeholder {
            color: var(--blue-mid);
            opacity: 0.6;
        }

        .fs-toggle-btn {
            background: var(--white);
            border: none;
            border-radius: 6px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--navy);
            box-shadow: var(--shadow-sm);
        }
        .fs-toggle-btn:hover { background: var(--light-bg); }
        
        .debug-panel { display: none; padding: 10px; background: #fef9e6; color: var(--orange); font-family: monospace; font-size: 11px; margin-bottom: 10px; border-radius: 6px;}
        .debug-panel.show { display: block; }

        .feature-label {
            background: rgba(15, 36, 88, 0.85);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            pointer-events: none;
        }

        /* ─── Layer Panel ──────────────────────────────────── */
        .layer-panel {
            position: absolute;
            top: 12px;
            right: 52px;
            z-index: 200;
            width: 220px;
            background: var(--navy);
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            color: var(--white);
            font-size: 13px;
            transform: translateX(calc(100% + 52px));
            opacity: 0;
            transition: transform 0.25s ease, opacity 0.2s ease;
            pointer-events: none;
        }
        .layer-panel.open {
            transform: translateX(0);
            opacity: 1;
            pointer-events: auto;
        }
        .layer-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px 8px;
        }
        .layer-panel-title {
            font-weight: 600;
            font-size: 14px;
        }
        .layer-panel-close {
            background: none;
            border: none;
            color: var(--white);
            font-size: 20px;
            cursor: pointer;
            opacity: 0.7;
            line-height: 1;
            padding: 0 2px;
        }
        .layer-panel-close:hover { opacity: 1; }
        .layer-panel-section {
            padding: 8px 14px 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .layer-panel-section-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.5;
            margin-bottom: 6px;
        }
        .layer-radio, .layer-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
            cursor: pointer;
            font-size: 13px;
        }
        .layer-radio input, .layer-checkbox input {
            accent-color: var(--cyan);
            cursor: pointer;
        }

        /* ─── Upload Modal ─────────────────────────────────── */
        .upload-section { margin-bottom: 4px; }
        .upload-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 6px;
        }
        .upload-select {
            width: 100%;
            padding: 10px 12px;
            font-size: 13px;
            font-family: inherit;
            border: 2px solid var(--light-bg);
            border-radius: 8px;
            background: var(--white);
            color: var(--navy);
            cursor: pointer;
        }
        .upload-select:focus { outline: none; border-color: var(--cyan); }
        .upload-filename {
            font-size: 12px;
            color: var(--blue-mid);
            margin-top: 4px;
            word-break: break-all;
        }
        .upload-progress {
            height: 6px;
            background: var(--light-bg);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        .upload-progress-bar {
            height: 100%;
            background: var(--cyan);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }
        .upload-status {
            font-size: 12px;
            margin-top: 6px;
            min-height: 18px;
        }
        .upload-status.error { color: var(--orange); }
        .upload-status.success { color: var(--green); }
    </style>
</head>
<body>
    <div class="widget-container" id="widgetRoot">
        <div class="site-header">
            <div class="site-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
            </div>
            <div>
                <h4 id="siteName">Loading...</h4>
                <p id="siteInfo" style="font-size: 12px; opacity: 0.8;">Initializing map</p>
            </div>
        </div>
        
        <div class="debug-panel" id="debugPanel"></div>
        
        <div class="toolbar">
            <div class="toolbar-group">
                <button class="tool-btn" data-tool="Polygon" title="Draw Polygon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 22,8.5 22,15.5 12,22 2,15.5 2,8.5"/></svg> Polygon
                </button>
                <button class="tool-btn" data-tool="Box" title="Draw Rectangle">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg> Rectangle
                </button>
                <button class="tool-btn" data-tool="Circle" title="Draw Circle">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg> Circle
                </button>
            </div>
            
            <div class="toolbar-group">
                <button class="tool-btn" data-tool="LineString" title="Draw Line">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20L20 4"/><circle cx="4" cy="20" r="2" fill="currentColor"/><circle cx="20" cy="4" r="2" fill="currentColor"/></svg> Line
                </button>
                <button class="tool-btn" data-tool="Point" title="Place Point">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3" fill="currentColor"/><circle cx="12" cy="12" r="8"/></svg> Point
                </button>
            </div>
            
            <div class="toolbar-group">
                <button class="tool-btn" id="undoBtn" title="Undo Last">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6"/><path d="M3 13a9 9 0 1 0 3-7.7L3 7"/></svg> Undo
                </button>
                <button class="tool-btn danger" id="clearBtn" title="Clear All">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg> Clear
                </button>
            </div>

            <div class="toolbar-group">
                <button class="tool-btn success" id="downloadBtn" title="Download KML">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> KML
                </button>
            </div>
            
            <div class="layer-selector">
                <button class="tool-btn" id="layerPanelToggle" title="Toggle layer panel">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/></svg> Layers
                </button>
                <button class="tool-btn" id="uploadPanelToggle" title="Upload data">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> Upload
                </button>
            </div>
        </div>
        
        <div class="map-wrapper">
            <div id="map"></div>
            <div class="map-controls">
                <button class="fs-toggle-btn" id="fullscreenToggle" title="Toggle Fullscreen">
                    <svg id="icon-maximize" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                    </svg>
                    <svg id="icon-minimize" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="display:none">
                        <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>
                    </svg>
                </button>
            </div>
            <div class="map-overlay">
                Features: <span style="font-weight:600; color:var(--cyan)" id="featureCount">0</span>
            </div>

            <!-- Layer Panel -->
            <div class="layer-panel" id="layerPanel">
                <div class="layer-panel-header">
                    <span class="layer-panel-title">Layers</span>
                    <button class="layer-panel-close" id="layerPanelClose">&times;</button>
                </div>
                <div class="layer-panel-section">
                    <div class="layer-panel-section-title">Base Map</div>
                    <label class="layer-radio"><input type="radio" name="baseLayer" value="ortho" checked> Orthoimage</label>
                    <label class="layer-radio"><input type="radio" name="baseLayer" value="satellite"> Satellite</label>
                    <label class="layer-radio"><input type="radio" name="baseLayer" value="osm"> Street</label>
                </div>
                <div class="layer-panel-section">
                    <div class="layer-panel-section-title">Overlays</div>
                    <div id="overlayCheckboxes"></div>
                </div>
            </div>
        </div>
        
        <div class="status-bar">
            <div style="display: flex; align-items: center;">
                <span class="status-dot ready" id="statusDot"></span>
                <span id="statusText">Ready</span>
            </div>
            <span id="coordDisplay" style="font-family: monospace;">--</span>
        </div>
        
        <!-- Generic confirmation modal -->
        <div class="modal-overlay" id="genericModal">
            <div class="modal-box">
                <div class="modal-title" id="modalTitle">Title</div>
                <div class="modal-message" id="modalMessage">Message</div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" id="modalCancel">Cancel</button>
                    <button class="modal-btn primary" id="modalConfirm">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Feature naming modal -->
        <div class="modal-overlay" id="nameModal">
            <div class="modal-box">
                <div class="modal-title" id="nameModalTitle">Name this feature</div>
                <div class="modal-message" id="nameModalMessage">Enter a name for this shape (optional)</div>
                <input type="text" class="name-input" id="featureNameInput" placeholder="e.g., Stockpile A, Haul Road, Waypoint 1" maxlength="50" autocomplete="off">
                <div class="modal-buttons">
                    <button class="modal-btn cancel" id="nameModalSkip">Skip</button>
                    <button class="modal-btn primary" id="nameModalSave">Save</button>
                </div>
            </div>
        </div>

        <!-- Upload modal -->
        <div class="modal-overlay" id="uploadModal">
            <div class="modal-box" style="max-width: 420px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
                    <div class="modal-title" style="margin-bottom:0">Upload Data</div>
                    <button class="layer-panel-close" id="uploadModalClose" style="color:var(--navy)">&times;</button>
                </div>

                <div class="upload-section">
                    <label class="upload-label">Site</label>
                    <select class="upload-select" id="uploadSite"></select>
                </div>

                <div class="upload-section">
                    <label class="upload-label">Secret Key</label>
                    <input type="password" class="name-input" id="uploadSecret" placeholder="Enter upload secret" style="margin-bottom:0">
                </div>

                <hr style="border:none; border-top:1px solid var(--light-bg); margin: 16px 0;">

                <div class="upload-section">
                    <div class="upload-label">Orthoimage (GeoTIFF)</div>
                    <input type="file" id="tifFileInput" accept=".tif,.tiff" style="display:none">
                    <button class="tool-btn" id="tifChooseBtn" style="width:100%; justify-content:center;">Choose TIF file...</button>
                    <div class="upload-filename" id="tifFilename"></div>
                    <button class="modal-btn primary" id="tifUploadBtn" style="width:100%; margin-top:8px; display:none;">Upload &amp; Generate Tiles</button>
                    <div class="upload-progress" id="tifProgress" style="display:none;">
                        <div class="upload-progress-bar" id="tifProgressBar"></div>
                    </div>
                    <div class="upload-status" id="tifStatus"></div>
                </div>

                <hr style="border:none; border-top:1px solid var(--light-bg); margin: 16px 0;">

                <div class="upload-section">
                    <div class="upload-label">KML Overlay</div>
                    <select class="upload-select" id="uploadLayerType">
                        <option value="boundaries">Site Areas (Boundaries)</option>
                        <option value="infrastructure">Infrastructure</option>
                        <option value="nfz-permanent">No Fly Zones (Permanent)</option>
                        <option value="nfz-daily">No Fly Zones (Daily)</option>
                    </select>
                    <input type="file" id="kmlFileInput" accept=".kml" style="display:none; margin-top:8px;">
                    <button class="tool-btn" id="kmlChooseBtn" style="width:100%; justify-content:center; margin-top:8px;">Choose KML file...</button>
                    <div class="upload-filename" id="kmlFilename"></div>
                    <button class="modal-btn primary" id="kmlUploadBtn" style="width:100%; margin-top:8px; display:none;">Upload KML</button>
                    <div class="upload-status" id="kmlStatus"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            'use strict';

            // SITES config is loaded from config.js

            const State = {
                map: null,
                drawSource: null,
                drawInteraction: null,
                featureHistory: [],
                labelLayer: null,
                vectorLayers: {},
                pendingFeature: null,
                featureCounter: 0,
                site: null
            };

            const LAYER_CONFIG = {
                boundaries:     { style: null, label: 'Site Areas' },
                infrastructure: { style: null, label: 'Infrastructure' },
                nfzPermanent:   { style: null, label: 'No Fly Zones (Permanent)' },
                nfzDaily:       { style: null, label: 'No Fly Zones (Daily)' }
            };

            function getUrlParam(name) { return new URLSearchParams(window.location.search).get(name); }
            function debug(msg) { 
                const el = document.getElementById('debugPanel');
                if (el) { el.classList.add('show'); el.innerHTML += msg + '<br>'; }
                console.log('[Widget]', msg);
            }

            const Modal = {
                el: document.getElementById('genericModal'),
                titleEl: document.getElementById('modalTitle'),
                msgEl: document.getElementById('modalMessage'),
                confirmBtn: document.getElementById('modalConfirm'),
                cancelBtn: document.getElementById('modalCancel'),

                show(title, message, confirmText, type, onConfirm) {
                    this.titleEl.textContent = title;
                    this.msgEl.textContent = message;
                    this.confirmBtn.textContent = confirmText || 'Confirm';
                    this.confirmBtn.className = `modal-btn ${type === 'danger' ? 'danger' : 'primary'}`;
                    
                    const newConfirm = this.confirmBtn.cloneNode(true);
                    this.confirmBtn.parentNode.replaceChild(newConfirm, this.confirmBtn);
                    this.confirmBtn = newConfirm;

                    this.confirmBtn.addEventListener('click', () => {
                        this.hide();
                        if (onConfirm) onConfirm();
                    });

                    this.el.classList.add('show');
                },
                hide() {
                    this.el.classList.remove('show');
                }
            };

            const NameModal = {
                show(feature, featureType) {
                    State.pendingFeature = feature;
                    State.featureCounter++;
                    const defaultName = `${featureType} ${State.featureCounter}`;
                    
                    document.getElementById('nameModalTitle').textContent = `Name this ${featureType.toLowerCase()}`;
                    document.getElementById('nameModalMessage').textContent = `Enter a name to identify this ${featureType.toLowerCase()} in the exported KML`;
                    
                    const input = document.getElementById('featureNameInput');
                    input.value = '';
                    input.placeholder = `e.g., ${defaultName}, Stockpile A, Survey Area`;
                    
                    document.getElementById('nameModal').classList.add('show');
                    setTimeout(() => input.focus(), 100);
                },
                save() {
                    const input = document.getElementById('featureNameInput');
                    const name = input.value.trim() || `Feature ${State.featureCounter}`;
                    
                    if (State.pendingFeature) {
                        State.pendingFeature.set('name', name);
                        updateLabels();
                    }
                    
                    NameModal.hide();
                    sendToJotForm();
                    setStatus('ready', `"${name}" added`);
                },
                skip() {
                    const defaultName = `Feature ${State.featureCounter}`;
                    if (State.pendingFeature) {
                        State.pendingFeature.set('name', defaultName);
                        updateLabels();
                    }
                    NameModal.hide();
                    sendToJotForm();
                    setStatus('ready', 'Feature added');
                },
                hide() {
                    document.getElementById('nameModal').classList.remove('show');
                    State.pendingFeature = null;
                }
            };

            function getFeatureTypeLabel(geometry) {
                const type = geometry.getType();
                switch(type) {
                    case 'Polygon': return 'Polygon';
                    case 'Point': return 'Waypoint';
                    case 'LineString': return 'Line';
                    case 'Circle': return 'Circle';
                    default: return 'Feature';
                }
            }

            // ─── Layer Style Functions ────────────────────────────────

            function labelStyle(name, fillColor, strokeColor) {
                if (!name) return null;
                return new ol.style.Style({
                    text: new ol.style.Text({
                        text: name,
                        font: '500 12px DM Sans, sans-serif',
                        fill: new ol.style.Fill({ color: fillColor }),
                        stroke: new ol.style.Stroke({ color: strokeColor, width: 3 }),
                        overflow: true
                    }),
                    geometry: function(feature) {
                        const geom = feature.getGeometry();
                        if (geom.getType() === 'Polygon' || geom.getType() === 'MultiPolygon') {
                            return new ol.geom.Point(ol.extent.getCenter(geom.getExtent()));
                        }
                        return geom;
                    }
                });
            }

            function createBoundaryStyle(feature) {
                const name = feature.get('name') || '';
                const styles = [
                    new ol.style.Style({
                        stroke: new ol.style.Stroke({ color: '#ffffff', width: 2 })
                    })
                ];
                const lbl = labelStyle(name, '#ffffff', 'rgba(0, 0, 0, 0.6)');
                if (lbl) styles.push(lbl);
                return styles;
            }

            function createInfraStyle(feature) {
                const name = feature.get('name') || '';
                const styles = [
                    new ol.style.Style({
                        stroke: new ol.style.Stroke({ color: '#F59E0B', width: 2, lineDash: [8, 6] }),
                        image: new ol.style.Circle({
                            radius: 5,
                            fill: new ol.style.Fill({ color: '#F59E0B' }),
                            stroke: new ol.style.Stroke({ color: '#ffffff', width: 1.5 })
                        })
                    })
                ];
                const lbl = labelStyle(name, '#FEE980', 'rgba(0, 0, 0, 0.7)');
                if (lbl) styles.push(lbl);
                return styles;
            }

            function createNfzPermStyle(feature) {
                const name = feature.get('name') || '';
                const styles = [
                    new ol.style.Style({
                        fill: new ol.style.Fill({ color: 'rgba(239, 68, 68, 0.2)' }),
                        stroke: new ol.style.Stroke({ color: '#EF4444', width: 2 }),
                        image: new ol.style.Circle({
                            radius: 5,
                            fill: new ol.style.Fill({ color: '#EF4444' }),
                            stroke: new ol.style.Stroke({ color: '#ffffff', width: 1.5 })
                        })
                    })
                ];
                const lbl = labelStyle(name, '#FCA5A5', 'rgba(0, 0, 0, 0.7)');
                if (lbl) styles.push(lbl);
                return styles;
            }

            function createNfzDailyStyle(feature) {
                const name = feature.get('name') || '';
                const styles = [
                    new ol.style.Style({
                        fill: new ol.style.Fill({ color: 'rgba(251, 146, 60, 0.2)' }),
                        stroke: new ol.style.Stroke({ color: '#FB923C', width: 2, lineDash: [10, 5] }),
                        image: new ol.style.Circle({
                            radius: 5,
                            fill: new ol.style.Fill({ color: '#FB923C' }),
                            stroke: new ol.style.Stroke({ color: '#ffffff', width: 1.5 })
                        })
                    })
                ];
                const lbl = labelStyle(name, '#FDBA74', 'rgba(0, 0, 0, 0.7)');
                if (lbl) styles.push(lbl);
                return styles;
            }

            function initMap() {
                const siteKey = getUrlParam('site');
                State.site = SITES[siteKey];

                if (!State.site) {
                    debug('ERROR: Site key not found. Use ?site=key');
                    document.getElementById('siteName').textContent = 'Configuration Error';
                    return;
                }

                LAYER_CONFIG.boundaries.style = createBoundaryStyle;
                LAYER_CONFIG.infrastructure.style = createInfraStyle;
                LAYER_CONFIG.nfzPermanent.style = createNfzPermStyle;
                LAYER_CONFIG.nfzDaily.style = createNfzDailyStyle;

                document.getElementById('siteName').textContent = State.site.name;
                document.getElementById('siteInfo').textContent = State.site.company;

                // ─── Base Layers ──────────────────────────────────────
                const osm = new ol.layer.Tile({ source: new ol.source.OSM(), visible: false, properties: {name: 'osm'} });
                const satellite = new ol.layer.Tile({ 
                    source: new ol.source.XYZ({ url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', maxZoom: 19 }), 
                    visible: false,
                    properties: {name: 'satellite'} 
                });
                const ortho = new ol.layer.Tile({
                    source: new ol.source.XYZ({ url: State.site.tileUrl, minZoom: 14, maxZoom: 21 }),
                    visible: true,
                    properties: {name: 'ortho'}
                });

                const layers = [osm, satellite, ortho];

                // ─── Vector Overlay Layers (from KML) ────────────────
                if (State.site.layers) {
                    for (const [key, url] of Object.entries(State.site.layers)) {
                        if (!url) continue;
                        const cfg = LAYER_CONFIG[key];
                        if (!cfg) continue;

                        const layer = new ol.layer.Vector({
                            source: new ol.source.Vector({
                                url: url,
                                format: new ol.format.KML({ extractStyles: false, showPointNames: false })
                            }),
                            style: cfg.style,
                            visible: true,
                            properties: { name: key, label: cfg.label }
                        });

                        layer.getSource().on('featuresloadend', function() {
                            console.log('[Widget] Loaded ' + layer.getSource().getFeatures().length + ' ' + key + ' feature(s)');
                        });
                        layer.getSource().on('featuresloaderror', function() {
                            console.warn('[Widget] Failed to load ' + key + ' KML from: ' + url);
                        });

                        State.vectorLayers[key] = layer;
                        layers.push(layer);
                    }
                }

                // ─── Draw Layer ──────────────────────────────────────
                State.drawSource = new ol.source.Vector();
                const drawLayer = new ol.layer.Vector({
                    source: State.drawSource,
                    style: new ol.style.Style({
                        fill: new ol.style.Fill({ color: 'rgba(10, 186, 239, 0.2)' }),
                        stroke: new ol.style.Stroke({ color: '#0ABAEF', width: 2 }),
                        image: new ol.style.Circle({ radius: 6, fill: new ol.style.Fill({ color: '#0ABAEF' }), stroke: new ol.style.Stroke({ color: '#fff', width: 2 }) })
                    })
                });

                // ─── Label Layer ─────────────────────────────────────
                State.labelLayer = new ol.layer.Vector({
                    source: new ol.source.Vector(),
                    style: function(feature) {
                        return new ol.style.Style({
                            text: new ol.style.Text({
                                text: feature.get('label'),
                                font: '600 13px DM Sans, sans-serif',
                                fill: new ol.style.Fill({ color: '#ffffff' }),
                                backgroundFill: new ol.style.Fill({ color: 'rgba(15, 36, 88, 0.85)' }),
                                padding: [4, 8, 4, 8],
                                offsetY: -20
                            })
                        });
                    }
                });

                layers.push(drawLayer, State.labelLayer);

                // ─── Map Instance ────────────────────────────────────
                State.map = new ol.Map({
                    target: 'map',
                    layers: layers,
                    view: new ol.View({
                        center: ol.proj.fromLonLat(State.site.center),
                        zoom: State.site.defaultZoom,
                        maxZoom: 21
                    }),
                    controls: ol.control.defaults.defaults({ zoom: false }).extend([new ol.control.ScaleLine()])
                });

                State.map.on('pointermove', evt => {
                    const coords = ol.proj.toLonLat(evt.coordinate);
                    document.getElementById('coordDisplay').textContent = `${coords[1].toFixed(5)}, ${coords[0].toFixed(5)}`;
                });

                State.drawSource.on('change', () => {
                    document.getElementById('featureCount').textContent = State.drawSource.getFeatures().length;
                });
            }

            function updateLabels() {
                const labelSource = State.labelLayer.getSource();
                labelSource.clear();
                
                State.drawSource.getFeatures().forEach(feature => {
                    const name = feature.get('name');
                    if (!name) return;
                    
                    let geom = feature.getGeometry();
                    let labelPoint;
                    
                    if (geom.getType() === 'Point') {
                        labelPoint = geom.getCoordinates();
                    } else if (geom.getType() === 'Circle') {
                        labelPoint = geom.getCenter();
                    } else {
                        labelPoint = ol.extent.getCenter(geom.getExtent());
                    }
                    
                    const labelFeature = new ol.Feature({
                        geometry: new ol.geom.Point(labelPoint),
                        label: name
                    });
                    labelSource.addFeature(labelFeature);
                });
            }

            function setTool(toolType) {
                if (State.drawInteraction) State.map.removeInteraction(State.drawInteraction);
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                if (!toolType) { setStatus('ready', 'Ready'); return; }
                document.querySelector(`[data-tool="${toolType}"]`).classList.add('active');
                const geometryFunction = toolType === 'Box' ? ol.interaction.Draw.createBox() : undefined;
                const type = (toolType === 'Box' || toolType === 'Circle') ? 'Circle' : toolType;
                State.drawInteraction = new ol.interaction.Draw({ source: State.drawSource, type: type, geometryFunction: geometryFunction });
                State.drawInteraction.on('drawstart', () => setStatus('drawing', 'Drawing...'));
                State.drawInteraction.on('drawend', (e) => {
                    State.featureHistory.push(e.feature);
                    setStatus('ready', 'Name your feature...');
                    let featureType = getFeatureTypeLabel(e.feature.getGeometry());
                    if (toolType === 'Box') featureType = 'Rectangle';
                    NameModal.show(e.feature, featureType);
                });
                State.map.addInteraction(State.drawInteraction);
                setStatus('ready', `${toolType} active`);
            }

            function setStatus(status, text) {
                document.getElementById('statusDot').className = `status-dot ${status}`;
                document.getElementById('statusText').textContent = text;
            }

            function switchBaseLayer(layerName) {
                State.map.getLayers().forEach(lyr => {
                    const name = lyr.get('name');
                    if (name === 'osm' || name === 'satellite' || name === 'ortho') {
                        lyr.setVisible(name === layerName);
                    }
                });
                document.querySelectorAll('input[name="baseLayer"]').forEach(r => {
                    r.checked = (r.value === layerName);
                });
            }

            function toggleOverlay(key, visible) {
                const layer = State.vectorLayers[key];
                if (!layer) return;
                layer.setVisible(visible);
            }

            function toggleLayerPanel() {
                const panel = document.getElementById('layerPanel');
                panel.classList.toggle('open');
            }

            function clearFeatures() {
                if (State.drawSource.getFeatures().length === 0) return;
                Modal.show('Clear All Features?', 'This will remove all shapes you have drawn. This action cannot be undone.', 'Clear All', 'danger', () => {
                    State.drawSource.clear();
                    State.labelLayer.getSource().clear();
                    State.featureHistory = [];
                    State.featureCounter = 0;
                    sendToJotForm();
                    setStatus('ready', 'Canvas cleared');
                });
            }

            function toggleFullscreen() {
                const doc = document.documentElement;
                if (!document.fullscreenElement) {
                    Modal.show('Enter Fullscreen Mode?', 'This will maximize the map. You can exit by pressing ESC.', 'Go Fullscreen', 'primary', () => {
                        if (doc.requestFullscreen) doc.requestFullscreen();
                        else if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
                        else if (doc.msRequestFullscreen) doc.msRequestFullscreen();
                    });
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                }
            }

            function updateFullscreenUI() {
                const isFs = !!document.fullscreenElement;
                document.getElementById('icon-maximize').style.display = isFs ? 'none' : 'block';
                document.getElementById('icon-minimize').style.display = isFs ? 'block' : 'none';
                document.getElementById('fullscreenToggle').title = isFs ? "Exit Fullscreen" : "Toggle Fullscreen";
                setTimeout(() => State.map && State.map.updateSize(), 200);
            }

            const qid = getUrlParam('qid');
            const inJotForm = (window.self !== window.top) && qid;

            function generateKMLString() {
                const features = State.drawSource.getFeatures();
                if (!features.length) return '';
                
                let placemarks = '';
                
                features.forEach((feature, index) => {
                    let geom = feature.getGeometry().clone();
                    const featureName = feature.get('name') || `Feature ${index + 1}`;
                    
                    if (geom.getType() === 'Circle') {
                        geom = ol.geom.Polygon.fromCircle(geom, 64);
                    }
                    
                    geom.transform('EPSG:3857', 'EPSG:4326');
                    
                    const geomType = geom.getType();
                    let geometryKML = '';
                    
                    if (geomType === 'Polygon') {
                        const coords = geom.getCoordinates()[0];
                        const coordString = coords.map(c => `${c[0]},${c[1]},0`).join(' ');
                        geometryKML = '<Polygon><tessellate>1</tessellate><outerBoundaryIs><LinearRing><coordinates>' + coordString + '</coordinates></LinearRing></outerBoundaryIs></Polygon>';
                    } else if (geomType === 'Point') {
                        const coords = geom.getCoordinates();
                        geometryKML = '<Point><coordinates>' + coords[0] + ',' + coords[1] + ',0</coordinates></Point>';
                    } else if (geomType === 'LineString') {
                        const coords = geom.getCoordinates();
                        const coordString = coords.map(c => `${c[0]},${c[1]},0`).join(' ');
                        geometryKML = '<LineString><tessellate>1</tessellate><coordinates>' + coordString + '</coordinates></LineString>';
                    }
                    
                    placemarks += '<Placemark><name>' + escapeXml(featureName) + '</name><Style><LineStyle><color>ff00aaff</color><width>2</width></LineStyle><PolyStyle><color>4c00aaff</color></PolyStyle></Style>' + geometryKML + '</Placemark>';
                });
                
                const kml = '<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2" xmlns:gx="http://www.google.com/kml/ext/2.2"><Document><name>Mission Area</name>' + placemarks + '</Document></kml>';
                
                return kml;
            }

            function escapeXml(str) {
                return str.replace(/&/g, '&amp;')
                          .replace(/</g, '&lt;')
                          .replace(/>/g, '&gt;')
                          .replace(/"/g, '&quot;')
                          .replace(/'/g, '&apos;');
            }

            function downloadKML() {
                const kml = generateKMLString();
                if (!kml) { setStatus('ready', 'Nothing to download'); return; }
                const blob = new Blob([kml], {type: 'application/vnd.google-earth.kml+xml'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `map-drawing-${Date.now()}.kml`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                setStatus('ready', 'Download started');
            }

            function sendToJotForm() {
                if (!inJotForm) return;
                const kml = generateKMLString();
                window.parent.postMessage(JSON.stringify({ type: 'data', qid: qid, value: kml, valid: true }), '*');
            }

            function buildOverlayCheckboxes() {
                const container = document.getElementById('overlayCheckboxes');
                container.innerHTML = '';
                for (const [key, cfg] of Object.entries(LAYER_CONFIG)) {
                    const layer = State.vectorLayers[key];
                    if (!layer) continue;
                    const label = document.createElement('label');
                    label.className = 'layer-checkbox';
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.checked = true;
                    cb.addEventListener('change', () => toggleOverlay(key, cb.checked));
                    label.appendChild(cb);
                    label.appendChild(document.createTextNode(cfg.label));
                    container.appendChild(label);
                }
                if (!container.children.length) {
                    container.innerHTML = '<div style="opacity:0.5; font-size:12px; padding:4px 0;">No overlays for this site</div>';
                }
            }

            // ─── Upload Modal Logic ──────────────────────────────
            function initUploadModal() {
                const uploadToggle = document.getElementById('uploadPanelToggle');
                const uploadModal = document.getElementById('uploadModal');
                const uploadClose = document.getElementById('uploadModalClose');

                uploadToggle.addEventListener('click', () => {
                    populateSiteSelector();
                    uploadModal.classList.add('show');
                });
                uploadClose.addEventListener('click', () => uploadModal.classList.remove('show'));
                uploadModal.addEventListener('click', (e) => { if (e.target === uploadModal) uploadModal.classList.remove('show'); });

                document.getElementById('tifChooseBtn').addEventListener('click', () => document.getElementById('tifFileInput').click());
                document.getElementById('tifFileInput').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        document.getElementById('tifFilename').textContent = file.name + ' (' + (file.size / 1024 / 1024).toFixed(1) + ' MB)';
                        document.getElementById('tifUploadBtn').style.display = 'block';
                    }
                });

                document.getElementById('kmlChooseBtn').addEventListener('click', () => document.getElementById('kmlFileInput').click());
                document.getElementById('kmlFileInput').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        document.getElementById('kmlFilename').textContent = file.name;
                        document.getElementById('kmlUploadBtn').style.display = 'block';
                    }
                });

                document.getElementById('tifUploadBtn').addEventListener('click', uploadTif);
                document.getElementById('kmlUploadBtn').addEventListener('click', uploadKml);
            }

            function populateSiteSelector() {
                const sel = document.getElementById('uploadSite');
                if (sel.options.length > 0) return;
                for (const [key, site] of Object.entries(SITES)) {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = site.name + ' (' + site.company + ')';
                    if (State.site && State.site.name === site.name) opt.selected = true;
                    sel.appendChild(opt);
                }
            }

            function getUploadHeaders() {
                return { 'X-Upload-Secret': document.getElementById('uploadSecret').value.trim() };
            }

            function uploadTif() {
                const file = document.getElementById('tifFileInput').files[0];
                if (!file) return;
                if (!SERVER_URL) { showUploadStatus('tifStatus', 'Server URL not configured in config.js', true); return; }

                const site = document.getElementById('uploadSite').value;
                const formData = new FormData();
                formData.append('file', file);
                formData.append('site', site);

                const xhr = new XMLHttpRequest();
                const progressEl = document.getElementById('tifProgress');
                const barEl = document.getElementById('tifProgressBar');
                const statusEl = document.getElementById('tifStatus');
                const btn = document.getElementById('tifUploadBtn');

                progressEl.style.display = 'block';
                btn.disabled = true;
                btn.textContent = 'Uploading...';
                statusEl.textContent = '';
                statusEl.className = 'upload-status';

                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        barEl.style.width = Math.round(e.loaded / e.total * 100) + '%';
                    }
                };

                xhr.onload = function() {
                    if (xhr.status === 202) {
                        const data = JSON.parse(xhr.responseText);
                        barEl.style.width = '100%';
                        statusEl.textContent = 'Upload complete. Generating tiles...';
                        pollTifStatus(data.jobId);
                    } else {
                        try { showUploadStatus('tifStatus', JSON.parse(xhr.responseText).error, true); }
                        catch { showUploadStatus('tifStatus', 'Upload failed (HTTP ' + xhr.status + ')', true); }
                        btn.disabled = false;
                        btn.textContent = 'Upload & Generate Tiles';
                    }
                };

                xhr.onerror = function() {
                    showUploadStatus('tifStatus', 'Network error — is the server running?', true);
                    btn.disabled = false;
                    btn.textContent = 'Upload & Generate Tiles';
                };

                xhr.open('POST', SERVER_URL + '/api/upload-tif');
                const headers = getUploadHeaders();
                for (const [k, v] of Object.entries(headers)) xhr.setRequestHeader(k, v);
                xhr.send(formData);
            }

            function pollTifStatus(jobId) {
                const statusEl = document.getElementById('tifStatus');
                const btn = document.getElementById('tifUploadBtn');

                const poll = () => {
                    fetch(SERVER_URL + '/api/status/' + jobId)
                        .then(r => r.json())
                        .then(data => {
                            statusEl.textContent = data.message || data.status;
                            if (data.status === 'complete') {
                                statusEl.className = 'upload-status success';
                                btn.disabled = false;
                                btn.textContent = 'Upload & Generate Tiles';
                            } else if (data.status === 'error') {
                                statusEl.className = 'upload-status error';
                                btn.disabled = false;
                                btn.textContent = 'Upload & Generate Tiles';
                            } else {
                                setTimeout(poll, 3000);
                            }
                        })
                        .catch(() => {
                            showUploadStatus('tifStatus', 'Lost connection to server', true);
                            btn.disabled = false;
                            btn.textContent = 'Upload & Generate Tiles';
                        });
                };
                setTimeout(poll, 2000);
            }

            function uploadKml() {
                const file = document.getElementById('kmlFileInput').files[0];
                if (!file) return;
                if (!SERVER_URL) { showUploadStatus('kmlStatus', 'Server URL not configured in config.js', true); return; }

                const site = document.getElementById('uploadSite').value;
                const layerType = document.getElementById('uploadLayerType').value;
                const formData = new FormData();
                formData.append('file', file);
                formData.append('site', site);
                formData.append('layerType', layerType);

                const btn = document.getElementById('kmlUploadBtn');
                btn.disabled = true;
                btn.textContent = 'Uploading...';

                fetch(SERVER_URL + '/api/upload-kml', {
                    method: 'POST',
                    headers: getUploadHeaders(),
                    body: formData
                })
                .then(r => r.json().then(d => ({ ok: r.ok, data: d })))
                .then(({ ok, data }) => {
                    if (ok) {
                        showUploadStatus('kmlStatus', 'Uploaded to ' + data.url, false);
                    } else {
                        showUploadStatus('kmlStatus', data.error || 'Upload failed', true);
                    }
                    btn.disabled = false;
                    btn.textContent = 'Upload KML';
                })
                .catch(() => {
                    showUploadStatus('kmlStatus', 'Network error — is the server running?', true);
                    btn.disabled = false;
                    btn.textContent = 'Upload KML';
                });
            }

            function showUploadStatus(elId, msg, isError) {
                const el = document.getElementById(elId);
                el.textContent = msg;
                el.className = 'upload-status ' + (isError ? 'error' : 'success');
            }

            function init() {
                initMap();
                document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                    btn.addEventListener('click', () => setTool(btn.classList.contains('active') ? null : btn.dataset.tool));
                });
                document.getElementById('undoBtn').addEventListener('click', () => {
                    if (State.featureHistory.length) {
                        State.drawSource.removeFeature(State.featureHistory.pop());
                        updateLabels();
                        sendToJotForm();
                    }
                });
                document.getElementById('clearBtn').addEventListener('click', clearFeatures);
                document.getElementById('downloadBtn').addEventListener('click', downloadKML);
                document.getElementById('layerPanelToggle').addEventListener('click', toggleLayerPanel);
                document.getElementById('layerPanelClose').addEventListener('click', toggleLayerPanel);
                document.querySelectorAll('input[name="baseLayer"]').forEach(r => {
                    r.addEventListener('change', () => switchBaseLayer(r.value));
                });
                buildOverlayCheckboxes();

                initUploadModal();

                document.getElementById('fullscreenToggle').addEventListener('click', toggleFullscreen);
                document.addEventListener('fullscreenchange', updateFullscreenUI);
                Modal.cancelBtn.addEventListener('click', () => Modal.hide());
                document.getElementById('genericModal').addEventListener('click', (e) => { if(e.target.id === 'genericModal') Modal.hide(); });
                
                document.getElementById('nameModalSave').addEventListener('click', () => NameModal.save());
                document.getElementById('nameModalSkip').addEventListener('click', () => NameModal.skip());
                document.getElementById('featureNameInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') NameModal.save();
                    if (e.key === 'Escape') NameModal.skip();
                });
                
                let resizeTimer;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => State.map && State.map.updateSize(), 100);
                });
                if (inJotForm) { 
                    window.parent.postMessage(JSON.stringify({ type: 'frameReady', qid: qid }), '*');
                    sendToJotForm();
                    
                    window.addEventListener('message', function(e) {
                        try {
                            const data = typeof e.data === 'string' ? JSON.parse(e.data) : e.data;
                            if (data.type === 'submit') {
                                const kml = generateKMLString();
                                window.parent.postMessage(JSON.stringify({
                                    type: 'submit',
                                    qid: qid,
                                    value: kml,
                                    valid: true
                                }), '*');
                            }
                        } catch (err) {}
                    });
                }
            }

            init();
        })();
    </script>
</body>
</html>
